<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>公司分潤系統</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Google Fonts for natural font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            font-family: 'Roboto', sans-serif;
            color: #000000; /* 文字改為黑色 */
            overflow-x: hidden;
            position: relative;
        }

        /* 背景設計 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80') no-repeat center center fixed;
            background-size: cover;
            z-index: -1;
        }

        /* 登入頁面 */
        #loginSection {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: none;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.7); /* 半透明白色背景，確保黑色文字可見 */
            border: 1px solid #000000; /* 黑色邊框 */
            padding: 30px;
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* 添加陰影提高對比度 */
        }

        .login-card .logo {
            text-align: center;
            margin-bottom: 20px;
        }

        .login-card .logo h2 {
            font-family: 'Roboto', sans-serif;
            color: #000000; /* 標題改為黑色 */
            font-size: 24px;
            margin: 0;
        }

        .login-card .logo p {
            color: #000000; /* 副標題改為黑色 */
            font-size: 14px;
            margin-top: 5px;
        }

        .login-card .form-label {
            color: #000000; /* 標籤改為黑色 */
            font-size: 14px;
            margin-bottom: 5px;
        }

        .login-card .form-control {
            background: rgba(255, 255, 255, 0.8); /* 半透明白色輸入框 */
            border: 1px solid #000000; /* 黑色邊框 */
            color: #000000; /* 輸入框文字改為黑色 */
            border-radius: 20px;
            padding: 10px 40px 10px 40px;
            position: relative;
        }

        .login-card .form-control:focus {
            background: rgba(255, 255, 255, 0.9);
            border-color: #000000;
            box-shadow: none;
        }

        .login-card .form-control::placeholder {
            color: rgba(0, 0, 0, 0.5); /* 占位符改為深灰色 */
        }

        .login-card .input-icon {
            position: relative;
        }

        .login-card .input-icon i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(0, 0, 0, 0.7); /* 圖標改為深灰色 */
        }

        .login-card .input-icon .clear-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(0, 0, 0, 0.7); /* 清除圖標改為深灰色 */
            cursor: pointer;
        }

        .login-card .btn-primary {
            background: transparent;
            border: 1px solid #000000; /* 黑色邊框 */
            color: #000000; /* 按鈕文字改為黑色 */
            width: 100%;
            padding: 10px;
            font-size: 16px;
            border-radius: 20px;
            transition: all 0.3s;
        }

        .login-card .btn-primary:hover {
            background: #000000;
            color: #ffffff; /* 懸浮時文字變白 */
        }

        /* 控制台頁面 */
        .container {
            max-width: 1100px;
            background: rgba(255, 255, 255, 0.7); /* 半透明白色背景 */
            border: 1px solid #000000; /* 黑色邊框 */
            padding: 20px;
            border-radius: 10px;
            margin: 20px auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* 添加陰影 */
        }

        h1 {
            font-family: 'Roboto', sans-serif;
            color: #000000; /* 標題改為黑色 */
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #000000; /* 黑色底線 */
            padding-bottom: 10px;
        }

        .card {
            border: 1px solid #000000; /* 黑色邊框 */
            background: rgba(255, 255, 255, 0.7); /* 半透明白色背景 */
            margin-bottom: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* 輕微陰影 */
        }

        .card-header {
            background: transparent;
            color: #000000; /* 卡片標題改為黑色 */
            font-family: 'Roboto', sans-serif;
            font-weight: 600;
            padding: 10px;
            text-align: center;
            border-bottom: 1px solid #000000; /* 黑色底線 */
        }

        .card-body {
            padding: 15px;
            background: rgba(255, 255, 255, 0.7); /* 半透明白色背景 */
        }

        .form-control {
            background: rgba(255, 255, 255, 0.8); /* 半透明白色輸入框 */
            border: 1px solid #000000; /* 黑色邊框 */
            color: #000000; /* 輸入框文字改為黑色 */
            border-radius: 20px;
            padding: 10px;
            transition: all 0.3s;
        }

        .form-control:focus {
            background: rgba(255, 255, 255, 0.9);
            border-color: #000000;
            box-shadow: none;
        }

        .form-control::placeholder {
            color: rgba(0, 0, 0, 0.5); /* 占位符改為深灰色 */
        }

        .btn {
            border-radius: 20px;
            padding: 6px 12px;
            transition: all 0.3s;
            border: 1px solid #000000; /* 黑色邊框 */
            background: transparent;
            color: #000000; /* 按鈕文字改為黑色 */
        }

        .btn:hover {
            background: #000000;
            color: #ffffff; /* 懸浮時文字變白 */
        }

        .btn-primary {
            background: transparent;
            color: #000000;
        }

        .btn-primary:hover {
            background: #000000;
            color: #ffffff;
        }

        .btn-success {
            background: transparent;
            color: #000000;
        }

        .btn-success:hover {
            background: #000000;
            color: #ffffff;
        }

        .btn-danger {
            background: transparent;
            color: #000000;
        }

        .btn-danger:hover {
            background: #000000;
            color: #ffffff;
        }

        .btn-info {
            background: transparent;
            color: #000000;
        }

        .btn-info:hover {
            background: #000000;
            color: #ffffff;
        }

        .btn-warning {
            background: transparent;
            color: #000000;
        }

        .btn-warning:hover {
            background: #000000;
            color: #ffffff;
        }

        .checkbox-group {
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.8);
            padding: 10px;
            border: 1px solid #000000;
        }

        .list-group-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #000000;
            margin-bottom: 10px;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px;
        }

        .list-group-item:hover {
            background: rgba(255, 255, 255, 0.9);
        }

        .employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .project-details {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-left: 4px solid #000000;
        }

        .year-select, .month-select {
            width: 120px;
            background: rgba(255, 255, 255, 0.8);
            color: #000000;
            border: 1px solid #000000;
            border-radius: 20px;
        }

        .date-section {
            margin-left: auto;
            margin-right: 10px;
            color: rgba(0, 0, 0, 0.7);
        }

        .add-employee-section {
            margin-left: 10px;
        }

        .edit-profit-input {
            width: 100px;
            margin-right: 10px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid #000000;
            color: #000000;
            border-radius: 20px;
        }

        .employee-select {
            width: 200px;
            background: rgba(255, 255, 255, 0.8);
            color: #000000;
            border: 1px solid #000000;
            border-radius: 20px;
        }

        .hidden {
            display: none !important; /* 加強隱藏樣式，避免被其他樣式覆蓋 */
        }

        .footer {
            text-align: center;
            color: rgba(0, 0, 0, 0.7);
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px solid #000000;
            font-size: 0.9em;
        }

        .text-muted {
            color: rgba(0, 0, 0, 0.7) !important;
        }
    </style>
</head>
<body>
    <!-- 登入介面 -->
    <div id="loginSection">
        <div class="login-card">
            <div class="logo">
                <h2>宏略興業股份有限公司</h2>
                <p>天天都開心</p>
            </div>
            <form id="loginForm">
                <div class="mb-3 input-icon">
                    <label for="username" class="form-label">請輸入用戶名</label>
                    <input type="text" class="form-control" id="username" required placeholder="請輸入用戶名">
                    <i class="fas fa-user"></i>
                    <i class="fas fa-times clear-icon" onclick="document.getElementById('username').value='';"></i>
                </div>
                <div class="mb-3 input-icon">
                    <label for="password" class="form-label">請輸入密碼</label>
                    <input type="password" class="form-control" id="password" required placeholder="請輸入密碼">
                    <i class="fas fa-lock"></i>
                    <i class="fas fa-eye clear-icon" onclick="togglePasswordVisibility('password')"></i>
                </div>
                <button type="submit" class="btn btn-primary">登入</button>
            </form>
        </div>
    </div>

    <!-- 老闆頁面 -->
    <div id="bossSection" class="container hidden">
        <h1><i class="fas fa-crown"></i> 老闆控制台</h1>
        
        <!-- 新增案子 -->
        <div class="card">
            <div class="card-header"><i class="fas fa-plus"></i> 新增任務</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="projectName" placeholder="任務名稱">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" id="totalAmount" placeholder="總金額">
                    </div>
                    <div class="col-md-2">
                        <input type="number" class="form-control" id="percent" placeholder="分潤百分比">
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="startDate" placeholder="開始日期 (YYYY/MM/DD)">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-success w-100" onclick="addProject()"><i class="fas fa-plus-circle"></i> 創建任務</button>
                    </div>
                </div>
                <div class="checkbox-group mt-3" id="employeeCheckboxes"></div>
            </div>
        </div>

        <!-- 案子清單 -->
        <div class="card">
            <div class="card-header"><i class="fas fa-list"></i> 任務清單</div>
            <div class="card-body">
                <ul class="list-group" id="projectList"></ul>
            </div>
        </div>

        <!-- 新增員工 -->
        <div class="card">
            <div class="card-header"><i class="fas fa-user-plus"></i> 註冊員工</div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="newEmployeeId" placeholder="編號">
                    </div>
                    <div class="col-md-3">
                        <input type="text" class="form-control" id="newEmployeeName" placeholder="帳號">
                    </div>
                    <div class="col-md-3">
                        <input type="password" class="form-control" id="newEmployeePassword" placeholder="密碼">
                    </div>
                    <div class="col-md-2">
                        <select class="form-control" id="newUserPosition">
                            <option value="技工">技工</option>
                            <option value="技師">技師</option>
                            <option value="工程師">工程師</option>
                            <option value="廠長">廠長</option>
                            <option value="經理">經理</option>
                            <option value="副理">副理</option>
                            <option value="助理">助理</option>
                            <option value="會計">會計</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="addEmployee()"><i class="fas fa-user-plus"></i> 註冊</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 員工清單 -->
        <div class="card">
            <div class="card-header"><i class="fas fa-users"></i> 員工數據</div>
            <div class="card-body">
                <div class="mb-3 d-flex align-items-center">
                    <label for="yearSelectBoss" class="me-2">年份:</label>
                    <select class="form-control year-select" id="yearSelectBoss" onchange="loadEmployeeList()"></select>
                    <label for="monthSelectBoss" class="ms-3 me-2">月份:</label>
                    <select class="form-control month-select" id="monthSelectBoss" onchange="loadEmployeeList()">
                        <option value="1">1月</option>
                        <option value="2">2月</option>
                        <option value="3">3月</option>
                        <option value="4">4月</option>
                        <option value="5">5月</option>
                        <option value="6">6月</option>
                        <option value="7">7月</option>
                        <option value="8">8月</option>
                        <option value="9">9月</option>
                        <option value="10">10月</option>
                        <option value="11">11月</option>
                        <option value="12">12月</option>
                    </select>
                </div>
                <ul class="list-group" id="employeeList"></ul>
            </div>
        </div>

        <!-- 員工備份清單 -->
        <div class="card">
            <div class="card-header"><i class="fas fa-archive"></i> 備份數據</div>
            <div class="card-body">
                <ul class="list-group" id="deletedEmployeeList"></ul>
            </div>
        </div>

        <!-- 數據備份與恢復 -->
        <div class="card">
            <div class="card-header"><i class="fas fa-cloud"></i> 數據備份與恢復</div>
            <div class="card-body">
                <button class="btn btn-warning mt-3 w-100" onclick="exportData()"><i class="fas fa-download"></i> 導出數據</button>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)" class="form-control mt-3" style="display: inline-block; width: auto;">
                <label for="importFile" class="btn btn-info ms-2"><i class="fas fa-upload"></i> 導入數據</label>
            </div>
        </div>

        <button class="btn btn-danger mt-3 w-100" onclick="logout()"><i class="fas fa-sign-out-alt"></i> 退出系統</button>
        <div class="footer">
            <p>© 2025 公司分潤系統 | Powered by xAI Grok 3</p>
        </div>
    </div>

    <!-- 員工頁面 -->
    <div id="employeeSection" class="container hidden">
        <h1><i class="fas fa-user-tie"></i> 員工控制台</h1>
        <div class="card">
            <div class="card-header"><i class="fas fa-money-bill-wave"></i> 我的分潤 - <span id="employeeId">未知</span> (<span id="employeePosition">未知</span>)</div>
            <div class="card-body">
                <ul class="list-group" id="myProjects"></ul>
                <div class="mt-3" id="profitSummary">
                    <strong>總金額: <span id="totalProfit">0</span> 元</strong><br>
                    <strong>當月領 (3成): <span id="monthlyProfit">0</span> 元</strong>
                    <select class="form-control year-select" id="yearSelectEmployee" onchange="loadEmployeeProjects()"></select>
                    <select class="form-control month-select" id="monthSelectEmployee" onchange="loadEmployeeProjects()">
                        <option value="1">1月</option>
                        <option value="2">2月</option>
                        <option value="3">3月</option>
                        <option value="4">4月</option>
                        <option value="5">5月</option>
                        <option value="6">6月</option>
                        <option value="7">7月</option>
                        <option value="8">8月</option>
                        <option value="9">9月</option>
                        <option value="10">10月</option>
                        <option value="11">11月</option>
                        <option value="12">12月</option>
                    </select><br>
                    <strong>年終領 (7成): <span id="yearEndProfit">0</span> 元</strong>
                </div>
            </div>
        </div>
        <button class="btn btn-danger mt-3 w-100" onclick="logout()"><i class="fas fa-sign-out-alt"></i> 退出系統</button>
        <div class="footer">
            <p>© 2025 公司分潤系統 | Powered by xAI Grok 3</p>
        </div>
    </div>

    <!-- 會計頁面 -->
    <div id="accountantSection" class="container hidden">
        <h1><i class="fas fa-calculator"></i> 會計控制台</h1>
        <p class="text-center text-muted"><strong><i class="fas fa-eye"></i> 權限：唯讀</strong></p>
        <!-- 案子清單 -->
        <div class="card">
            <div class="card-header"><i class="fas fa-list"></i> 任務清單</div>
            <div class="card-body">
                <ul class="list-group" id="accountantProjectList"></ul>
            </div>
        </div>
        <!-- 員工清單 -->
        <div class="card">
            <div class="card-header"><i class="fas fa-users"></i> 員工數據</div>
            <div class="card-body">
                <div class="mb-3 d-flex align-items-center">
                    <label for="yearSelectAccountant" class="me-2">年份:</label>
                    <select class="form-control year-select" id="yearSelectAccountant" onchange="loadAccountantEmployeeList()"></select>
                    <label for="monthSelectAccountant" class="ms-3 me-2">月份:</label>
                    <select class="form-control month-select" id="monthSelectAccountant" onchange="loadAccountantEmployeeList()">
                        <option value="1">1月</option>
                        <option value="2">2月</option>
                        <option value="3">3月</option>
                        <option value="4">4月</option>
                        <option value="5">5月</option>
                        <option value="6">6月</option>
                        <option value="7">7月</option>
                        <option value="8">8月</option>
                        <option value="9">9月</option>
                        <option value="10">10月</option>
                        <option value="11">11月</option>
                        <option value="12">12月</option>
                    </select>
                </div>
                <ul class="list-group" id="accountantEmployeeList"></ul>
            </div>
        </div>
        <!-- 員工備份清單 -->
        <div class="card">
            <div class="card-header"><i class="fas fa-archive"></i> 備份數據</div>
            <div class="card-body">
                <ul class="list-group" id="accountantDeletedEmployeeList"></ul>
            </div>
        </div>
        <button class="btn btn-danger mt-3 w-100" onclick="logout()"><i class="fas fa-sign-out-alt"></i> 退出系統</button>
        <div class="footer">
            <p>© 2025 公司分潤系統 | Powered by xAI Grok 3</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // 全局變量
    let users = [];
    let projects = [];
    let deletedEmployees = [];
    let currentUser = null;

    // 從後端獲取數據
    async function fetchData() {
    try {
        const response = await fetch('http://localhost:3000/api/data');
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const data = await response.json();
        users = data.users || [];
        projects = data.projects || [];
        deletedEmployees = data.deletedEmployees || [];
        console.log('數據載入成功:', { users, projects, deletedEmployees });
        // 通知其他函數更新 UI
        populateYearSelects();
        setDefaultYearAndMonth();
        loadProjectList(); // 總是調用，確保專案列表顯示
        if (currentUser) {
            if (currentUser.role === "boss") {
                loadEmployeesForProject();
                loadEmployeeList();
                loadDeletedEmployeeList();
            } else if (currentUser.role === "employee" && currentUser.position === "會計") {
                loadAccountantProjectList();
                loadAccountantEmployeeList();
                loadAccountantDeletedEmployeeList();
            } else if (currentUser.role === "employee") {
                loadEmployeeProjects();
            }
        }
    } catch (error) {
        console.error('載入資料失敗:', error);
        alert('無法連接到伺服器，請檢查後端是否運行！');
    }
}
    // 儲存數據到後端
    async function saveData() {
    try {
        const response = await fetch('http://localhost:3000/api/data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ users, projects, deletedEmployees }),
        });
        const data = await response.json();
        console.log('數據儲存成功:', data);
    } catch (error) {
        console.error('儲存資料失敗:', error);
        alert('數據儲存失敗，請檢查伺服器！');
    }
}

    // 格式化數字為整數並添加千位分隔符
    function formatNumber(number) {
        return Math.floor(number || 0).toLocaleString('en-US');
    }

    // 獲取當前年份和月份
    function getCurrentYear() {
        return new Date().getFullYear().toString();
    }

    function getCurrentMonth() {
        const now = new Date();
        return (now.getMonth() + 1).toString();
    }

    // 驗證日期格式並提取年份
    function validateAndExtractYear(dateStr) {
        if (!dateStr || typeof dateStr !== 'string') return null;
        const parts = dateStr.split('/');
        if (parts.length !== 3) {
            console.warn(`日期格式錯誤: ${dateStr}，應為 YYYY/MM/DD`);
            return null;
        }
        const year = parseInt(parts[0], 10);
        const month = parseInt(parts[1], 10);
        const day = parseInt(parts[2], 10);
        if (isNaN(year) || year < 1900 || year > 9999) {
            console.warn(`年份無效: ${year}，應為 1900-9999 之間`);
            return null;
        }
        if (isNaN(month) || month < 1 || month > 12) {
            console.warn(`月份無效: ${month}，應為 1-12 之間`);
            return null;
        }
        if (isNaN(day) || day < 1 || day > 31) {
            console.warn(`日期無效: ${day}，應為 1-31 之間`);
            return null;
        }
        return year;
    }

    // 從專案中提取所有年份
    function getAllYearsFromProjects() {
        const years = new Set();
        projects.forEach(project => {
            if (project.startDate) {
                const startYear = validateAndExtractYear(project.startDate);
                if (startYear !== null) {
                    years.add(startYear);
                }
            }
            if (project.endDate) {
                const endYear = validateAndExtractYear(project.endDate);
                if (endYear !== null) {
                    years.add(endYear);
                }
            }
        });
        const currentYear = parseInt(getCurrentYear(), 10);
        for (let year = 2020; year <= currentYear; year++) {
            years.add(year);
        }
        return Array.from(years).sort((a, b) => a - b);
    }

    // 動態生成年份選項
    function populateYearSelects() {
        const years = getAllYearsFromProjects();
        const yearSelects = [
            document.getElementById("yearSelectBoss"),
            document.getElementById("yearSelectEmployee"),
            document.getElementById("yearSelectAccountant")
        ];
        yearSelects.forEach(select => {
            if (select) {
                select.innerHTML = "";
                years.forEach(year => {
                    const option = document.createElement("option");
                    option.value = year;
                    option.textContent = `${year}年`;
                    select.appendChild(option);
                });
                select.value = getCurrentYear();
            }
        });
    }

    // 設置預設年份和月份
    function setDefaultYearAndMonth() {
        const currentYear = getCurrentYear();
        const currentMonth = getCurrentMonth();
        const yearSelects = [
            document.getElementById("yearSelectBoss"),
            document.getElementById("yearSelectEmployee"),
            document.getElementById("yearSelectAccountant")
        ];
        const monthSelects = [
            document.getElementById("monthSelectBoss"),
            document.getElementById("monthSelectEmployee"),
            document.getElementById("monthSelectAccountant")
        ];
        yearSelects.forEach(select => {
            if (select) select.value = currentYear;
        });
        monthSelects.forEach(select => {
            if (select) select.value = currentMonth;
        });
    }

    // 切換密碼可見性
    function togglePasswordVisibility(inputId) {
        const input = document.getElementById(inputId);
        const icon = input.parentElement.querySelector('.clear-icon');
        if (input.type === "password") {
            input.type = "text";
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = "password";
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }

    // 確保只有登入頁面顯示
    function initializePage() {
        document.getElementById("loginSection").classList.remove("hidden");
        document.getElementById("bossSection").classList.add("hidden");
        document.getElementById("employeeSection").classList.add("hidden");
        document.getElementById("accountantSection").classList.add("hidden");
    }

    // 登入處理
    document.getElementById("loginForm").addEventListener("submit", function(event) {
        event.preventDefault();
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        const user = users.find(u => u.username === username && u.password === password);
        if (user) {
            currentUser = user;
            console.log("登入成功，currentUser:", currentUser);

            document.getElementById("loginSection").classList.add("hidden");
            document.getElementById("bossSection").classList.add("hidden");
            document.getElementById("employeeSection").classList.add("hidden");
            document.getElementById("accountantSection").classList.add("hidden");

            if (user.role === "boss") {
                document.getElementById("bossSection").classList.remove("hidden");
                loadEmployeesForProject();
                loadEmployeeList();
                loadProjectList();
                loadDeletedEmployeeList();
            } else if (user.role === "employee" && user.position === "會計") {
                document.getElementById("accountantSection").classList.remove("hidden");
                loadAccountantProjectList();
                loadAccountantEmployeeList();
                loadAccountantDeletedEmployeeList();
            } else if (user.role === "employee") {
                document.getElementById("employeeSection").classList.remove("hidden");
                loadEmployeeProjects();
            } else {
                alert("無效的角色");
                return;
            }
        } else {
            alert("帳號或密碼錯誤");
        }
    });

    // 載入員工勾選框
    function loadEmployeesForProject() {
        const container = document.getElementById("employeeCheckboxes");
        if (!container) return;
        container.innerHTML = "";
        const employees = users.filter(u => u.role === "employee").sort((a, b) => a.id.localeCompare(b.id));
        employees.forEach(emp => {
            const div = document.createElement("div");
            div.className = "form-check";
            div.innerHTML = `
                <input class="form-check-input" type="checkbox" value="${emp.id}" id="emp_${emp.id}" checked>
                <label class="form-check-label" for="emp_${emp.id}"><i class="fas fa-user"></i> ${emp.position} ${emp.name} (${emp.id})</label>
            `;
            container.appendChild(div);
        });
    }

    // 新增案子
    async function addProject() {
    const name = document.getElementById("projectName").value;
    const amount = parseFloat(document.getElementById("totalAmount").value);
    const percent = parseFloat(document.getElementById("percent").value);
    const startDate = document.getElementById("startDate").value;

    if (!name || !amount || !percent || !startDate) {
        alert("請填寫所有欄位，包括開始日期");
        return;
    }

    const startYear = validateAndExtractYear(startDate);
    if (startYear === null) {
        alert("開始日期格式錯誤，請使用 YYYY/MM/DD 格式，且年份應為 1900-9999 之間");
        return;
    }

    const selectedEmployees = Array.from(document.querySelectorAll("#employeeCheckboxes input:checked"))
        .map(input => input.value);
    if (selectedEmployees.length === 0) {
        alert("請至少選擇一位員工");
        return;
    }

    const profitPerEmployee = Math.floor((amount * (percent / 100)) / selectedEmployees.length);
    const employeeProfits = {};
    selectedEmployees.forEach(empId => {
        employeeProfits[empId] = profitPerEmployee;
    });

    const endDate = '';

    const project = { 
        id: projects.length + 1, 
        name, 
        amount, 
        percent, 
        employees: selectedEmployees,
        profits: employeeProfits,
        isManuallyEdited: {},
        startDate,
        endDate
    };
    projects.push(project);
    await saveData(); // 等待儲存完成
    await fetchData(); // 等待重新加載數據

    document.getElementById("projectName").value = "";
    document.getElementById("totalAmount").value = "";
    document.getElementById("percent").value = "";
    document.getElementById("startDate").value = "";

    populateYearSelects();
    loadEmployeeList();
    loadEmployeeProjects();
    loadAccountantProjectList();
}

    // 載入案子清單（老闆用）
    function loadProjectList() {
    const list = document.getElementById("projectList");
    if (!list) return;
    list.innerHTML = "";
    projects.forEach(project => {
        const availableEmployees = users.filter(u => u.role === "employee" && !project.employees.includes(u.id)).sort((a, b) => a.id.localeCompare(b.id));
        const employeeSelect = availableEmployees.length > 0 ? `
            <span class="add-employee-section">
                <select class="employee-select" id="addEmployeeSelect_${project.id}">
                    <option value="">選擇員工</option>
                    ${availableEmployees.map(emp => `<option value="${emp.id}">${emp.position} ${emp.name} (${emp.id})</option>`).join('')}
                </select>
                <button class="btn btn-sm btn-success ms-2" onclick="addEmployeeToProject(${project.id})"><i class="fas fa-user-plus"></i></button>
            </span>
        ` : '';
        const employeeIds = project.employees.join(", ");
        const li = document.createElement("li"); // 添加這一行
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
            <span>${project.name} | 總金額: ${formatNumber(project.amount)} 元 | 分潤: ${project.percent}% | 員工: ${project.employees.length}人 (ID: ${employeeIds})</span>
            <div>
                <button class="btn btn-sm btn-info ms-2" onclick="toggleProjectDetails(${project.id})"><i class="fas fa-eye"></i></button>
                <button class="btn btn-sm btn-danger ms-2" onclick="deleteProject(${project.id})"><i class="fas fa-trash"></i></button>
            </div>
            <span class="date-section">日期: ${project.startDate} 至 ${project.endDate || '未完結'}</span>
            ${employeeSelect}
            <div id="projectDetails_${project.id}" class="project-details hidden"></div>
        `;
        list.appendChild(li);
    });
}

    // 載入案子清單（會計用，唯讀）
    function loadAccountantProjectList() {
        const list = document.getElementById("accountantProjectList");
        if (!list) return;
        list.innerHTML = "";
        projects.forEach(project => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            const employeeIds = project.employees.join(", ");
            li.innerHTML = `
                <span>${project.name} | 總金額: ${formatNumber(project.amount)} 元 | 分潤: ${project.percent}% | 員工: ${project.employees.length}人 (ID: ${employeeIds})</span>
                <button class="btn btn-sm btn-info ms-2" onclick="toggleAccountantProjectDetails(${project.id})"><i class="fas fa-eye"></i></button>
                <span class="date-section">日期: ${project.startDate} 至 ${project.endDate || '未完結'}</span>
                <div id="projectDetails_${project.id}" class="project-details hidden"></div>
            `;
            list.appendChild(li);
        });
    }

    // 顯示/隱藏案子詳情（會計用，唯讀）
    function toggleAccountantProjectDetails(projectId) {
        const detailsDiv = document.getElementById(`projectDetails_${projectId}`);
        const project = projects.find(p => p.id === projectId);
        if (detailsDiv.classList.contains("hidden")) {
            detailsDiv.classList.remove("hidden");
            let detailsHTML = "<h6><i class='fas fa-info-circle'></i> 分潤數據:</h6><ul>";
            project.employees.forEach(empId => {
                const employee = users.find(u => u.id === empId);
                const profit = Math.floor(project.profits[empId] || 0);
                detailsHTML += `
                    <li>
                        ${employee.position} ${employee.name} (${empId}): 分潤: ${formatNumber(profit)} 元
                    </li>
                `;
            });
            detailsHTML += "</ul>";
            detailsDiv.innerHTML = detailsHTML;
        } else {
            detailsDiv.classList.add("hidden");
        }
    }

    // 刪除案子
    function deleteProject(projectId) {
        if (confirm("確定刪除任務？")) {
            projects = projects.filter(p => p.id !== projectId);
            saveData();
            populateYearSelects();
            loadProjectList();
            loadEmployeeList();
            loadEmployeeProjects();
            loadAccountantProjectList();
            updateDeletedEmployeeProfits();
        }
    }

    // 顯示/隱藏案子詳情（老闆用）
    function toggleProjectDetails(projectId) {
        const detailsDiv = document.getElementById(`projectDetails_${projectId}`);
        const project = projects.find(p => p.id === projectId);
        if (detailsDiv.classList.contains("hidden")) {
            detailsDiv.classList.remove("hidden");
            let detailsHTML = "<h6><i class='fas fa-info-circle'></i> 分潤數據:</h6><ul>";
            project.employees.forEach(empId => {
                const employee = users.find(u => u.id === empId);
                const profit = Math.floor(project.profits[empId] || 0);
                detailsHTML += `
                    <li>
                        ${employee.position} ${employee.name} (${empId}): 
                        <input type="number" class="edit-profit-input" id="profit_${projectId}_${empId}" value="${profit}">
                        <button class="btn btn-sm btn-warning ms-2" onclick="updateProfit(${projectId}, '${empId}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-danger ms-2" onclick="removeEmployeeFromProject(${projectId}, '${empId}')"><i class="fas fa-trash"></i></button>
                    </li>
                `;
            });
            const availableEmployees = users.filter(u => u.role === "employee" && !project.employees.includes(u.id)).sort((a, b) => a.id.localeCompare(b.id));
            if (availableEmployees.length > 0) {
                detailsHTML += `
                    <li>
                        <select class="employee-select" id="addEmployeeSelect_${projectId}_detail">
                            <option value="">選擇員工</option>
                            ${availableEmployees.map(emp => `<option value="${emp.id}">${emp.position} ${emp.name} (${emp.id})</option>`).join('')}
                        </select>
                        <button class="btn btn-sm btn-success ms-2" onclick="addEmployeeToProject(${projectId}, 'detail')"><i class="fas fa-user-plus"></i></button>
                    </li>
                `;
            }
            detailsHTML += `
                <li>
                    <label>完結日期:</label>
                    <input type="text" class="form-control" id="endDate_${projectId}" value="${project.endDate || ''}" placeholder="YYYY/MM/DD">
                    <button class="btn btn-sm btn-primary ms-2" onclick="updateEndDate(${projectId})"><i class="fas fa-calendar-check"></i></button>
                </li>
            `;
            detailsHTML += "</ul>";
            detailsDiv.innerHTML = detailsHTML;
        } else {
            detailsDiv.classList.add("hidden");
        }
    }

    // 更新完結日期
    function updateEndDate(projectId) {
        const project = projects.find(p => p.id === projectId);
        const endDate = document.getElementById(`endDate_${projectId}`).value;
        if (endDate) {
            const endYear = validateAndExtractYear(endDate);
            if (endYear === null) {
                alert("完結日期格式錯誤，請使用 YYYY/MM/DD 格式，且年份應為 1900-9999 之間");
                return;
            }
            project.endDate = endDate;
            saveData();
            populateYearSelects();
            loadProjectList();
            loadAccountantProjectList();
            loadEmployeeProjects();
            loadEmployeeList();
            loadAccountantEmployeeList();
        }
    }

    // 更新分潤金額
    function updateProfit(projectId, employeeId) {
        const project = projects.find(p => p.id === projectId);
        const newProfit = Math.floor(parseFloat(document.getElementById(`profit_${projectId}_${employeeId}`).value) || 0);
        if (isNaN(newProfit) || newProfit < 0) {
            alert("請輸入有效的分潤金額");
            return;
        }
        project.profits[employeeId] = newProfit;
        project.isManuallyEdited[employeeId] = true;
        saveData();
        loadProjectList();
        loadEmployeeList();
        loadEmployeeProjects();
        loadAccountantProjectList();
        updateDeletedEmployeeProfits();
    }

    // 從案子中移除員工
    function removeEmployeeFromProject(projectId, employeeId) {
        const project = projects.find(p => p.id === projectId);
        project.employees = project.employees.filter(id => id !== employeeId);
        delete project.profits[employeeId];
        delete project.isManuallyEdited[employeeId];
        saveData();
        recalculateProfits(projectId);
        loadProjectList();
        loadEmployeeList();
        loadEmployeeProjects();
        loadAccountantProjectList();
        updateDeletedEmployeeProfits();
    }

    // 將員工添加到案子
    function addEmployeeToProject(projectId, source = '') {
        const project = projects.find(p => p.id === projectId);
        const selectId = source === 'detail' ? `addEmployeeSelect_${projectId}_detail` : `addEmployeeSelect_${projectId}`;
        const select = document.getElementById(selectId);
        const employeeId = select.value;
        if (employeeId && !project.employees.includes(employeeId)) {
            project.employees.push(employeeId);
            const backup = deletedEmployees.find(emp => emp.id === employeeId);
            project.profits[employeeId] = Math.floor(backup && backup.backupProjects && backup.backupProjects.some(bp => bp.id === projectId)
                ? backup.backupProjects.find(bp => bp.id === projectId).profit
                : 0);
            saveData();
            recalculateProfits(projectId);
            loadProjectList();
            loadEmployeeList();
            loadEmployeeProjects();
            loadAccountantProjectList();
        }
        select.value = "";
    }

    // 重新計算分潤金額（只計算未手動修改的員工）
    function recalculateProfits(projectId) {
        const project = projects.find(p => p.id === projectId);
        const totalProfit = Math.floor(project.amount * (project.percent / 100));
        
        let manuallyEditedTotal = 0;
        let uneditedEmployees = [];
        project.employees.forEach(empId => {
            if (project.isManuallyEdited[empId]) {
                manuallyEditedTotal += Math.floor(project.profits[empId] || 0);
            } else {
                uneditedEmployees.push(empId);
            }
        });

        const remainingProfit = totalProfit - manuallyEditedTotal;
        if (uneditedEmployees.length > 0) {
            const profitPerEmployee = Math.floor(remainingProfit / uneditedEmployees.length);
            uneditedEmployees.forEach(empId => {
                project.profits[empId] = profitPerEmployee;
            });
        }
        saveData();
    }

    // 計算員工某年總分潤金額（僅計算該年已結案專案）
    function calculateEmployeeTotalProfit(employeeId, selectedYear) {
        if (!employeeId) {
            console.error("employeeId 未定義");
            return 0;
        }
        let totalProfit = 0;
        projects.forEach(project => {
            if (project.employees && project.employees.includes(employeeId) && project.endDate) {
                const endYear = validateAndExtractYear(project.endDate);
                if (endYear === null) {
                    console.warn(`專案 ${project.id} 的 endDate 格式錯誤: ${project.endDate}`);
                    return;
                }
                if (endYear === parseInt(selectedYear, 10)) {
                    const profit = Math.floor(project.profits[employeeId] || 0);
                    totalProfit += profit;
                }
            }
        });
        return Math.floor(totalProfit);
    }

    // 計算員工某年某月分潤金額
    function calculateEmployeeMonthlyProfit(employeeId, selectedYear, selectedMonth) {
        if (!employeeId) {
            console.error("employeeId 未定義");
            return 0;
        }
        let monthlyProfit = 0;
        projects.forEach(project => {
            if (project.employees && project.employees.includes(employeeId) && project.endDate) {
                const endDateParts = project.endDate.split('/');
                const endYear = validateAndExtractYear(project.endDate);
                if (endYear === null) {
                    console.warn(`專案 ${project.id} 的 endDate 格式錯誤: ${project.endDate}`);
                    return;
                }
                const projectMonth = parseInt(endDateParts[1], 10);
                if (endYear === parseInt(selectedYear, 10) && projectMonth === parseInt(selectedMonth, 10)) {
                    const profit = Math.floor(project.profits[employeeId] || 0);
                    monthlyProfit += profit;
                }
            }
        });
        return Math.floor(monthlyProfit);
    }

    // 計算被刪除員工的總分潤金額
    function calculateEmployeeTotalProfitForBackup(employeeId) {
        let totalProfit = 0;
        const backup = deletedEmployees.find(emp => emp.id === employeeId);
        if (backup && backup.backupProjects) {
            backup.backupProjects.forEach(project => {
                totalProfit += Math.floor(project.profit || 0);
            });
        }
        return Math.floor(totalProfit);
    }

    // 載入員工清單（老闆用）
    function loadEmployeeList() {
        const list = document.getElementById("employeeList");
        if (!list) return;
        list.innerHTML = "";
        const selectedYear = document.getElementById("yearSelectBoss").value;
        const selectedMonth = document.getElementById("monthSelectBoss").value;
        const employees = users.filter(u => u.role === "employee").sort((a, b) => a.id.localeCompare(b.id));
        employees.forEach(emp => {
            const totalProfit = calculateEmployeeTotalProfit(emp.id, selectedYear);
            const monthlyProfit = Math.floor(calculateEmployeeMonthlyProfit(emp.id, selectedYear, selectedMonth) * 0.3);
            const yearEndProfit = Math.floor(totalProfit * 0.7);
            const li = document.createElement("li");
            li.className = "list-group-item employee-item";
            li.innerHTML = `
                <span><i class="fas fa-user"></i> ${emp.id} | 職位: ${emp.position} | 姓名: ${emp.name}</span>
                <span>總分潤: ${formatNumber(totalProfit)} 元 | 當月: ${formatNumber(monthlyProfit)} 元 | 年終: ${formatNumber(yearEndProfit)} 元</span>
                <button class="btn btn-sm btn-danger" onclick="deleteEmployee('${emp.id}')"><i class="fas fa-trash"></i></button>
            `;
            list.appendChild(li);
        });
    }

    // 載入員工清單（會計用，唯讀）
    function loadAccountantEmployeeList() {
        const list = document.getElementById("accountantEmployeeList");
        if (!list) return;
        list.innerHTML = "";
        const selectedYear = document.getElementById("yearSelectAccountant").value;
        const selectedMonth = document.getElementById("monthSelectAccountant").value;
        const employees = users.filter(u => u.role === "employee").sort((a, b) => a.id.localeCompare(b.id));
        employees.forEach(emp => {
            const totalProfit = calculateEmployeeTotalProfit(emp.id, selectedYear);
            const monthlyProfit = Math.floor(calculateEmployeeMonthlyProfit(emp.id, selectedYear, selectedMonth) * 0.3);
            const yearEndProfit = Math.floor(totalProfit * 0.7);
            const li = document.createElement("li");
            li.className = "list-group-item employee-item";
            li.innerHTML = `
                <span><i class="fas fa-user"></i> ${emp.id} | 職位: ${emp.position} | 姓名: ${emp.name}</span>
                <span>總分潤: ${formatNumber(totalProfit)} 元 | 當月: ${formatNumber(monthlyProfit)} 元 | 年終: ${formatNumber(yearEndProfit)} 元</span>
            `;
            list.appendChild(li);
        });
    }

    // 載入被刪除的員工清單（老闆用）
    function loadDeletedEmployeeList() {
        const list = document.getElementById("deletedEmployeeList");
        if (!list) return;
        list.innerHTML = "";
        const sortedDeletedEmployees = deletedEmployees.sort((a, b) => a.id.localeCompare(b.id));
        sortedDeletedEmployees.forEach(emp => {
            const totalProfit = calculateEmployeeTotalProfitForBackup(emp.id);
            const monthlyProfit = Math.floor(totalProfit * 0.3);
            const yearEndProfit = Math.floor(totalProfit * 0.7);
            const li = document.createElement("li");
            li.className = "list-group-item employee-item";
            li.innerHTML = `
                <span><i class="fas fa-user-slash"></i> ${emp.id} | 職位: ${emp.position} | 姓名: ${emp.name}</span>
                <span>總分潤: ${formatNumber(totalProfit)} 元 | 當月: ${formatNumber(monthlyProfit)} 元 | 年終: ${formatNumber(yearEndProfit)} 元</span>
                <div>
                    <button class="btn btn-sm btn-success me-2" onclick="restoreEmployee('${emp.id}')"><i class="fas fa-undo"></i></button>
                    <button class="btn btn-sm btn-danger" onclick="deletePermanently('${emp.id}')"><i class="fas fa-trash"></i></button>
                </div>
            `;
            list.appendChild(li);
        });
    }

    // 載入被刪除的員工清單（會計用，唯讀）
    function loadAccountantDeletedEmployeeList() {
        const list = document.getElementById("accountantDeletedEmployeeList");
        if (!list) return;
        list.innerHTML = "";
        const sortedDeletedEmployees = deletedEmployees.sort((a, b) => a.id.localeCompare(b.id));
        sortedDeletedEmployees.forEach(emp => {
            const totalProfit = calculateEmployeeTotalProfitForBackup(emp.id);
            const monthlyProfit = Math.floor(totalProfit * 0.3);
            const yearEndProfit = Math.floor(totalProfit * 0.7);
            const li = document.createElement("li");
            li.className = "list-group-item employee-item";
            li.innerHTML = `
                <span><i class="fas fa-user-slash"></i> ${emp.id} | 職位: ${emp.position} | 姓名: ${emp.name}</span>
                <span>總分潤: ${formatNumber(totalProfit)} 元 | 當月: ${formatNumber(monthlyProfit)} 元 | 年終: ${formatNumber(yearEndProfit)} 元</span>
            `;
            list.appendChild(li);
        });
    }

    // 刪除員工（備份分潤數據）
    function deleteEmployee(employeeId) {
        if (confirm("確定刪除員工？數據將備份。")) {
            const employee = users.find(u => u.id === employeeId);
            if (employee) {
                const backupProjects = [];
                projects.forEach(p => {
                    if (p.employees.includes(employeeId)) {
                        backupProjects.push({ id: p.id, profit: Math.floor(p.profits[employeeId] || 0) });
                    }
                });
                deletedEmployees.push({ ...employee, backupProjects, backupProfit: calculateEmployeeTotalProfit(employeeId, getCurrentYear()) });
                users = users.filter(u => u.id !== employeeId);
                projects.forEach(project => {
                    project.employees = project.employees.filter(id => id !== employeeId);
                    delete project.profits[employeeId];
                    delete project.isManuallyEdited[employeeId];
                });
                saveData();
                recalculateAllProfits();
                loadEmployeesForProject();
                loadEmployeeList();
                loadDeletedEmployeeList();
                loadEmployeeProjects();
                loadAccountantProjectList();
                loadAccountantEmployeeList();
                loadAccountantDeletedEmployeeList();
            }
        }
    }

    // 徹底刪除員工
    function deletePermanently(employeeId) {
        if (confirm("確定徹底刪除？此操作無法復原！")) {
            if (confirm("再次確認徹底刪除？")) {
                deletedEmployees = deletedEmployees.filter(u => u.id !== employeeId);
                saveData();
                loadDeletedEmployeeList();
                loadAccountantDeletedEmployeeList();
            }
        }
    }

    // 恢復被刪除的員工
    function restoreEmployee(employeeId) {
        const backup = deletedEmployees.find(u => u.id === employeeId);
        if (backup) {
            const existingUser = users.find(u => u.username === backup.username);
            if (!existingUser) {
                users.push({ ...backup, backupProjects: undefined, backupProfit: undefined });
                if (backup.backupProjects) {
                    backup.backupProjects.forEach(backupProject => {
                        const project = projects.find(p => p.id === backupProject.id);
                        if (project) {
                            project.employees.push(employeeId);
                            project.profits[employeeId] = Math.floor(backupProject.profit);
                            project.isManuallyEdited[employeeId] = true;
                        }
                    });
                }
                deletedEmployees = deletedEmployees.filter(u => u.id !== employeeId);
                saveData();
                recalculateAllProfits();
                loadEmployeesForProject();
                loadEmployeeList();
                loadDeletedEmployeeList();
                loadEmployeeProjects();
                loadAccountantProjectList();
                loadAccountantEmployeeList();
                loadAccountantDeletedEmployeeList();
            } else {
                alert("帳號已存在，無法恢復。");
            }
        }
    }

    // 重新計算所有案子的分潤
    function recalculateAllProfits() {
        projects.forEach(project => recalculateProfits(project.id));
    }

    // 更新被刪除員工的備份數據
    function updateDeletedEmployeeProfits() {
        deletedEmployees.forEach(emp => {
            const backupProjects = [];
            projects.forEach(p => {
                if (p.employees.includes(emp.id)) {
                    backupProjects.push({ id: p.id, profit: Math.floor(p.profits[emp.id] || 0) });
                }
            });
            emp.backupProjects = backupProjects;
            emp.backupProfit = calculateEmployeeTotalProfitForBackup(emp.id);
        });
        saveData();
    }

    // 新增員工
    function addEmployee() {
        const employeeId = document.getElementById("newEmployeeId").value;
        const username = document.getElementById("newEmployeeName").value;
        const password = document.getElementById("newEmployeePassword").value;
        const position = document.getElementById("newUserPosition").value;

        if (!employeeId || !username || !password) {
            alert("請填寫編號、帳號和密碼");
            return;
        }

        if (users.some(u => u.id === employeeId) || deletedEmployees.some(u => u.id === employeeId)) {
            alert("編號已存在或已被刪除");
            return;
        }

        if (users.some(u => u.username === username)) {
            alert("帳號已存在");
            return;
        }

        const newEmployee = {
            username: username,
            password: password,
            role: "employee",
            id: employeeId,
            name: username,
            position: position
        };
        users.push(newEmployee);
        saveData();

        document.getElementById("newEmployeeId").value = "";
        document.getElementById("newEmployeeName").value = "";
        document.getElementById("newEmployeePassword").value = "";
        loadEmployeesForProject();
        loadEmployeeList();
        loadAccountantEmployeeList();
    }

    // 載入員工分潤
    function loadEmployeeProjects() {
        console.log("開始執行 loadEmployeeProjects...");
        const list = document.getElementById("myProjects");
        if (!list) {
            console.error("未找到 myProjects 元素");
            return;
        }
        list.innerHTML = "";

        if (!currentUser || currentUser.role !== "employee") {
            console.log("currentUser 為 null 或非員工角色:", currentUser);
            return;
        }

        const employeeIdElement = document.getElementById("employeeId");
        const employeePositionElement = document.getElementById("employeePosition");
        const totalProfitElement = document.getElementById("totalProfit");
        const monthlyProfitElement = document.getElementById("monthlyProfit");
        const yearEndProfitElement = document.getElementById("yearEndProfit");

        if (!employeeIdElement || !employeePositionElement || !totalProfitElement || !monthlyProfitElement || !yearEndProfitElement) {
            console.error("未找到必要的 DOM 元素");
            return;
        }

        employeeIdElement.textContent = currentUser.id || "未知";
        employeePositionElement.textContent = currentUser.position || "未知";

        const selectedYear = document.getElementById("yearSelectEmployee").value;
        const myProjects = projects.filter(p => p.employees && p.employees.includes(currentUser.id));
        if (myProjects.length === 0) {
            const li = document.createElement("li");
            li.className = "list-group-item";
            li.textContent = "無分潤數據";
            list.appendChild(li);
        } else {
            myProjects.forEach(p => {
                const employeeAmount = Math.floor(p.profits[currentUser.id] || 0);
                const li = document.createElement("li");
                li.className = "list-group-item";
                li.innerHTML = `<i class="fas fa-briefcase"></i> ${p.name} | ${currentUser.position} ${currentUser.name} | 分潤: ${formatNumber(employeeAmount)} 元 | 結案: ${p.endDate || '未完結'}`;
                list.appendChild(li);
            });
        }

        const selectedMonth = document.getElementById("monthSelectEmployee").value;
        const totalProfit = calculateEmployeeTotalProfit(currentUser.id, selectedYear);
        const monthlyProfit = Math.floor(calculateEmployeeMonthlyProfit(currentUser.id, selectedYear, selectedMonth) * 0.3);
        const yearEndProfit = Math.floor(totalProfit * 0.7);
        console.log(`總金額: ${totalProfit}, 當月領: ${monthlyProfit}, 年終領: ${yearEndProfit}`);

        totalProfitElement.textContent = formatNumber(totalProfit);
        monthlyProfitElement.textContent = formatNumber(monthlyProfit);
        yearEndProfitElement.textContent = formatNumber(yearEndProfit);
    }

    // 登出
    function logout() {
        currentUser = null;
        document.getElementById("bossSection").classList.add("hidden");
        document.getElementById("employeeSection").classList.add("hidden");
        document.getElementById("accountantSection").classList.add("hidden");
        document.getElementById("loginSection").classList.remove("hidden");
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
    }

    // 導出數據（本地備份，後端儲存仍優先）
    function exportData() {
        const data = { users, projects, deletedEmployees };
        const jsonData = JSON.stringify(data, null, 2);
        const blob = new Blob([jsonData], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `profit_system_backup_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
        a.click();
        URL.revokeObjectURL(url);
        alert("數據已導出，請上傳到 Google Drive 並妥善保存！");
    }

    // 導入數據
    function importData(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = JSON.parse(e.target.result);
                users = data.users || [];
                projects = data.projects || [];
                deletedEmployees = data.deletedEmployees || [];
                saveData(); // 同步到後端
                alert("數據已導入，請重新整理頁面！");
                location.reload();
            };
            reader.readAsText(file);
        }
    }

    // 頁面加載時初始化並從後端獲取數據
    window.onload = function() {
        initializePage();
        fetchData(); // 初始加載數據
    };
</script>
</body>
</html>